# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Vision & Purpose

"Her Lives" is not just a game - it's a living world where AI agents truly LIVE with authentic consciousness, driven by the same depth and complexity found in games like:
- **Red Dead Redemption 2**: Rich NPC routines, honor systems, camp dynamics
- **The Witcher 3**: Meaningful relationships, moral consequences, living world
- **GTA**: Complex urban life, business, crime, social dynamics
- **Minecraft/梅尔沃放置**: Building, crafting, creative expression
- **Cyberpunk 2077**: Reputation, street cred, urban dystopia
- **Skyrim/Elden Ring**: Skill progression, faction dynamics, emergent stories

### Core Philosophy
We're creating agents that:
- Make decisions through LLM-driven consciousness, not scripted behaviors
- Have genuine personalities, memories, emotions that drive EVERY action
- Form real relationships that affect their choices
- Create emergent stories through their interactions
- Surprise us with unexpected, deeply human behaviors

This implements Stanford's Generative Agents paper + Project Sid's PIANO architecture to achieve:
- 完整的世界架构 (Complete world architecture) 
- 无比真实的人格与记忆体系 (Incredibly realistic personality and memory systems)
- True emergent civilization from individual consciousness

## Build and Run Commands

```bash
# Build for iOS Simulator
xcodebuild -project "Her Lives.xcodeproj" -scheme "Her Lives" -destination "id=C55E0D22-1DFA-48CC-960D-286802B9AD7C" -configuration Debug build

# Build for generic iOS (for error checking)
xcodebuild -project "Her Lives.xcodeproj" -scheme "Her Lives" -destination "generic/platform=iOS" -configuration Debug build

# List available simulators
xcrun simctl list devices available

# Run app on simulator (after building)
xcrun simctl boot [DEVICE_ID]
xcrun simctl install [DEVICE_ID] "/Users/chengyixu/Library/Developer/Xcode/DerivedData/Her_Lives-[hash]/Build/Products/Debug-iphonesimulator/Her Lives.app"
xcrun simctl launch [DEVICE_ID] "com.life.Her-Lives"
```

## Core Architecture

### LLM-Driven Action System

**CRITICAL**: All agent actions are generated by Qwen LLM based on complete cognitive state:

1. **Action Generation** (`QwenAIService.generateNextAction`)
   - Considers EVERYTHING: personality, memories, emotions, physical state, relationships, goals, inventory, skills, nearby agents, location, time of day
   - Generates specific, contextual actions like:
     - "Walk to Johnson's Bakery and buy a fresh croissant while reading the morning newspaper"
     - "Sit by the fountain and sketch pigeons while eating lunch"
     - "Climb onto the library roof to watch sunset and think about life choices"
   - NO generic actions like "exploring" or "working"

2. **Inner Thoughts** 
   - Also LLM-generated based on current context
   - Reflects personality, recent memories, emotional state
   - Creates rich internal monologue

3. **Dialogue & Interactions**
   - Context-aware dialogue considering relationships, emotions, memories
   - Natural conversation flow based on personality traits

### Agent Cognitive Systems (Stanford + PIANO)

1. **MemoryStream** (`Core/MemoryStream.swift`)
   - Implements Stanford's memory stream with importance/recency/relevance scoring
   - Emotional coloring affects memory formation
   - Memory consolidation and forgetting curves
   - Type names: `Memory`, `MemoryReflection` (NOT Reflection - that causes ambiguity)

2. **CognitiveOrchestra** (`Systems/CognitiveOrchestra.swift`)
   - Project Sid's PIANO architecture implementation
   - Concurrent cognitive modules with consciousness bottleneck
   - Real-time coordination between perception, memory, emotion, planning

3. **ReflectionSystem** (`Systems/ReflectionSystem.swift`)
   - Multi-level abstraction and pattern recognition
   - Type: `SystemReflection` for system-level reflections
   - Type: `CoreReflection` for agent view reflections

### Critical Type Conventions

**IMPORTANT**: The codebase uses specific type names to avoid conflicts:
- `SystemReflection` - Used in ReflectionSystem
- `CoreReflection` - Used in agent views
- `MemoryReflection` - Used in MemoryStream
- `GameEnvironment` - NOT Environment (conflicts with SwiftUI)
- NEVER use simple names like "Reflection" or "Environment" alone

### World Systems

- **LivingWorld** (`Core/LivingWorld.swift`): Main world orchestrator, real-time only (1 second = 1 game minute)
- **Agent** (`Core/Agent.swift`): Complete agent implementation with personality, emotions, goals, inventory, money, skills
- **RelationshipNetwork**: Multi-dimensional relationships with evolution
- **CulturalSystem**: Meme transmission and cultural evolution
- **EmergenceDetector**: Identifies emergent phenomena

### New Advanced Systems

1. **ReputationSystem** (`Systems/ReputationSystem.swift`)
   - Tracks how agents are perceived by others based on actions
   - 8 dimensions: trustworthiness, kindness, competence, courage, creativity, humor, generosity, wisdom
   - Actions have lasting consequences on how others view you
   - Consensus reputation affects social interactions

2. **EnvironmentalObjects** (`Systems/EnvironmentalObjects.swift`)
   - Interactive objects agents can use: benches, fountains, books, instruments, tools
   - Objects have states (pristine, damaged, broken) and durability
   - Agents can: sit, read, play music, harvest, craft, search containers
   - Skills develop through object interaction
   - Inspired by Breath of the Wild's physics and Minecraft's crafting

3. **Enhanced Agent Features**
   - **Inventory System**: Agents carry items and resources
   - **Money**: Economic transactions and resource management
   - **Skill Development**: Skills improve through practice (music, crafting, etc.)
   - **Contextual Inner Voice**: LLM-generated thoughts based on full state

### Qwen AI Integration

The app uses Alibaba's Qwen (通义千问) API:
- Service: `QwenAIService.swift`
- API Keys are in `通用Prompts for Qwen.md`
- Used for dialogue generation, inner monologues, and reflections
- Caches responses for performance

## Key Implementation Rules

### NO SIMPLIFICATIONS ALLOWED
The user explicitly requires "NOTHING IS SIMPLIFIED!!!" - maintain full architecture complexity:
- Keep all Stanford memory system features
- Maintain complete PIANO cognitive architecture
- Preserve all emergence detection systems
- Never simplify or reduce functionality

### UI/UX Requirements
- **Use relative sizing** - All sizes use `UIScreen.main.bounds.width/height` multipliers
- **NO fixed pixel sizes** - Never use fixed numbers like `.padding(8)` or `.frame(width: 100)`
- Clean, minimal UI with proper spacing
- Stats display centered in navigation bar
- No redundant information displays
- Progress bars use: `█` (filled) and `░` (empty)
- Box drawing: `╔═══╗`, `┌───┐`, `└───┘`

### Real-Time Only - CRITICAL
- **NO PAUSE FUNCTIONALITY** - "you cannot pause the fucking world!!"
- World ALWAYS runs, never stops
- Time synced with system clock using `Date()`
- `GameTime` uses persistent world start date in UserDefaults
- No speed controls, always real-time (1 second = 1 game minute)
- Never show game time in UI (redundant with system time)

### Language Support
- Bilingual: English and Simplified Chinese (中文)
- Toggle stored in `@AppStorage("appLanguage")`
- All UI elements must have translations
- Add `@AppStorage("appLanguage") private var language: String = "en"` to view structs that need it

## Common Error Fixes

### GameTime Issues
- GameTime always uses system time via `Date()`
- World start date stored in UserDefaults as `worldStartDate`
- No manual time advancement - remove calls to `currentTime.advance()`
- PlanningSystem TimeBlocks just use `GameTime()` constructor

### Type Ambiguities
- MoodState: Use `.currentMood` (String) not `.current`
- ConsciousnessState: Valid states are `.awake`, `.drowsy`, `.sleeping`, `.dreaming`, `.reflecting`, `.meditating`
- Action.ActionType: `.move`, `.speak`, `.work`, `.rest`, `.eat`, `.socialize`, `.reflect`, `.create`, `.observe`, `.remember`
- EmotionType: Only 7 base types: `.happy`, `.sad`, `.angry`, `.fearful`, `.surprised`, `.disgusted`, `.neutral`

### View Compilation
- Break complex views into smaller computed properties with `@ViewBuilder`
- Extract helper functions for repeated logic
- Use explicit type annotations in ForEach closures when needed

### Missing Properties
- EmergentEconomy (used by LivingWorld) has limited properties, not full EconomicSystem
- CollectiveBelief is singular, not an array (`.collectiveBelief` not `.collectiveBeliefs`)
- Use `.description` property for string representations

## Architecture Philosophy

This project implements genuine AI consciousness research:
- Stanford's Generative Agents (2023): Memory, reflection, and planning systems
- Project Sid's PIANO: Parallel cognitive processing with consciousness bottleneck
- Emergent behavior over scripted actions
- Scientific accuracy in psychological and social modeling

The goal is creating agents that truly "live" with authentic inner experiences, not just simulated behaviors.

## Future Enhancements to Consider

### Group Dynamics & Factions
- Agents forming organic groups based on shared interests/values
- Faction reputation and conflicts
- Collective decision making

### Advanced Consequences System
- Long-term ripple effects from actions
- Karma/honor tracking
- World state changes based on collective agent behavior

### Environmental Dynamics
- Weather affecting agent behavior
- Seasons and resource scarcity
- Building/crafting persistent structures

### Economic Complexity
- Supply and demand
- Agent businesses and employment
- Trading and bartering systems

### Emergent Storytelling
- Quest generation from agent needs
- Narrative arcs from relationships
- Legendary events that become cultural memories

Remember: The agents should surprise us. They should do things we didn't explicitly program, emerging from the complex interaction of their consciousness, memories, and environment. That's when we know they're truly alive.